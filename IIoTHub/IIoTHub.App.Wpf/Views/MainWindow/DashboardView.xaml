<UserControl x:Class="IIoTHub.App.Wpf.Views.MainWindow.DashboardView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewmodels="clr-namespace:IIoTHub.App.Wpf.ViewModels.MainWindow"
             xmlns:converters="clr-namespace:IIoTHub.App.Wpf.ViewModels.MultiValueConverter"
             xmlns:domainEnums="clr-namespace:IIoTHub.Domain.Enums;assembly=IIoTHub.Domain"
             mc:Ignorable="d">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 上方 Dashboard 狀態總覽 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" HorizontalAlignment="Center">

            <!-- 稼動率 -->
            <Border Background="#2196F3" CornerRadius="6" Padding="15" Width="160" Height="90" Margin="10">
                <StackPanel>
                    <TextBlock Text="稼動率" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Text="{Binding AverageUtilization, StringFormat={}{0:P0}}" Foreground="White" FontSize="32" FontWeight="Bold"/>
                </StackPanel>
            </Border>

            <!-- 運轉 -->
            <Border Background="#4CAF50" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="運轉" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding RunDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 待機 -->
            <Border Background="#FF9800" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="待機" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding StandbyDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 報警 -->
            <Border Background="#F44336" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="警報" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding AlarmDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- 離線 -->
            <Border Background="#9E9E9E" CornerRadius="6" Padding="15" Width="160" Margin="10">
                <StackPanel>
                    <TextBlock Text="離線" Foreground="White" FontSize="16" FontWeight="Bold"/>
                    <TextBlock Foreground="White" FontWeight="Bold">
                        <Run Text="{Binding OfflineDeviceCount, Mode=OneWay}" FontSize="32"/>
                        <Run Text=" / " FontSize="16"/>
                        <Run Text="{Binding DeviceCount, Mode=OneWay}" FontSize="16"/>
                        <Run Text="台" FontSize="16"/>
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>

        <!-- 下方設備小卡清單 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="10">
            <ItemsControl ItemsSource="{Binding DevicesWithAddButton}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.Resources>
                    <converters:PercentageToDashArrayMultiConverter x:Key="PercentageToDashArrayMultiConverter"/>

                    <!-- 小卡模板 -->
                    <DataTemplate DataType="{x:Type viewmodels:DeviceViewModel}">
                        <Border CornerRadius="12" Background="White" Margin="10" Padding="0" Width="224" Height="300" Effect="{DynamicResource DropShadowEffectResource}">
                            <Grid>

                                <!-- 狀態色條 -->
                                <Border Height="12" VerticalAlignment="Top" CornerRadius="12,12,0,0">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Status}" Value="{x:Static domainEnums:DeviceRunStatus.Running}">
                                                    <Setter Property="Background" Value="#4CAF50"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="{x:Static domainEnums:DeviceRunStatus.Standby}">
                                                    <Setter Property="Background" Value="#FF9800"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="{x:Static domainEnums:DeviceRunStatus.Alarm}">
                                                    <Setter Property="Background" Value="#F44336"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Status}" Value="{x:Static domainEnums:DeviceRunStatus.Offline}">
                                                    <Setter Property="Background" Value="#9E9E9E"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>

                                <StackPanel Margin="12,24,12,12">

                                    <!-- 監控開關 -->
                                    <Grid Margin="0,0,0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <ToggleButton Grid.Column="1" Width="32" Height="16" ToolTip="監控開關" IsChecked="{Binding IsMonitoring, Mode=TwoWay}" Command="{Binding MonitorCommand}" Cursor="Hand">
                                            <ToggleButton.Template>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Grid>
                                                        <Border x:Name="Bg" CornerRadius="8" Background="#CCC"/>
                                                        <Ellipse x:Name="Dot" Width="12" Height="12" Fill="White" HorizontalAlignment="Left" Margin="2"/>
                                                    </Grid>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="Bg" Property="Background" Value="#4CAF50"/>
                                                            <Setter TargetName="Dot" Property="HorizontalAlignment" Value="Right"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </ToggleButton.Template>
                                        </ToggleButton>
                                    </Grid>

                                    <!-- 稼動率圓形進度條 -->
                                    <Grid Width="200" Height="200" Margin="0,0,0,12">
                                        <Ellipse Stroke="#eee" StrokeThickness="8" Width="200" Height="200"/>
                                        <Ellipse Stroke="#2196F3" StrokeThickness="8" Width="200" Height="200" StrokeDashCap="Round" RenderTransformOrigin="0.5,0.5">
                                            <Ellipse.StrokeDashArray>
                                                <MultiBinding Converter="{StaticResource PercentageToDashArrayMultiConverter}">
                                                    <Binding Path="Utilization"/>
                                                    <Binding RelativeSource="{RelativeSource Self}" Path="Width"/>
                                                    <Binding RelativeSource="{RelativeSource Self}" Path="StrokeThickness"/>
                                                </MultiBinding>
                                            </Ellipse.StrokeDashArray>
                                            <Ellipse.RenderTransform>
                                                <RotateTransform Angle="-90"/>
                                            </Ellipse.RenderTransform>
                                        </Ellipse>

                                        <!-- 內文: 設備名稱, 圖示, 稼動率百分比 -->
                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding Name}" FontSize="18" FontWeight="SemiBold" Foreground="#333" TextTrimming="CharacterEllipsis" HorizontalAlignment="Center"/>
                                            <Image Source="{Binding ImageSource}" Width="100" Height="100" Stretch="Uniform" HorizontalAlignment="Center" Margin="0,8,0,8"/>
                                            <TextBlock Text="{Binding Utilization, StringFormat={}{0:P0}}" FontWeight="Bold" FontSize="16" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>

                                    <!-- 按鈕列 -->
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding ViewCommand}" ToolTip="詳細資訊">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="DodgerBlue" Text="&#xE946;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Button>
                                        <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding EditCommand}" ToolTip="編輯">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Orange" Text="&#xE70F;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Button>
                                        <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Margin="0,0,8,0" Command="{Binding CopyCommand}" ToolTip="複製">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Green" Text="&#xE8C8;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Button>
                                        <Button Width="32" Height="32" Background="Transparent" BorderThickness="0" Cursor="Hand" Command="{Binding DeleteCommand}" ToolTip="刪除">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Foreground="Red" Text="&#xE74D;" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Button>
                                    </StackPanel>

                                </StackPanel>
                            </Grid>

                            <!-- 滑鼠懸浮動畫 -->
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Trigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.05" Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.05" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.EnterActions>
                                            <Trigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1" Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.ExitActions>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>

                        </Border>
                    </DataTemplate>

                    <!-- 新增設備小卡模板 -->
                    <DataTemplate DataType="{x:Type viewmodels:DevicePlaceholderViewModel}">
                        <Border CornerRadius="12" Background="#f5f5f5" Margin="10" Width="224" Height="280" Cursor="Hand" Effect="{DynamicResource DropShadowEffectResource}">
                            <Border.InputBindings>
                                <MouseBinding MouseAction="LeftClick" Command="{Binding AddCommand}" />
                            </Border.InputBindings>

                            <Grid>
                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <TextBlock Text="+" FontSize="36" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    <TextBlock Text="添加設備" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Grid>

                            <!-- 滑鼠懸浮動畫 -->
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="RenderTransform">
                                        <Setter.Value>
                                            <ScaleTransform ScaleX="1" ScaleY="1"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Trigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1.05" Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1.05" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.EnterActions>
                                            <Trigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleX" To="1" Duration="0:0:0.2"/>
                                                        <DoubleAnimation Storyboard.TargetProperty="RenderTransform.ScaleY" To="1" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.ExitActions>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>

                        </Border>
                    </DataTemplate>

                </ItemsControl.Resources>
            </ItemsControl>
        </ScrollViewer>

    </Grid>

</UserControl>